<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meet the Masters Art Program</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-400 */
        }
        /* Simple fade-in animation for content switching */
        .content-fade-enter {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 300ms ease-in-out, transform 300ms ease-in-out;
        }
        .content-fade-enter-active {
            opacity: 1;
            transform: translateY(0);
        }
        /* Style for form used in Admin page */
        .form-input {
            @apply mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700;
        }
        /* Styles for accordion */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
    </style>
</head>
<body class="h-full text-gray-800">
<div id="notification-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div id="notification-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="notification-title">Success!</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500" id="notification-message">
                    You have successfully signed up for the event.
                </p>
            </div>
            <div class="items-center px-4 py-3">
                <button id="notification-close-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                    OK
                </button>
            </div>
        </div>
    </div>
</div>


<div class="flex h-full">
    <aside id="desktop-sidebar" class="hidden md:flex md:flex-col md:w-64 md:flex-shrink-0 bg-white border-r border-gray-200">
        <div class="h-0 flex-1 flex flex-col pt-5 pb-4 overflow-y-auto">
            <div class="flex items-center flex-shrink-0 px-4">
                <svg class="h-8 w-8 text-blue-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9.75L14.25 12m0 0l2.25 2.25M14.25 12l2.25-2.25M14.25 12L12 14.25m-2.58 4.92l-6.375-6.375a1.125 1.125 0 010-1.59L9.42 4.83c.211-.211.498-.33.796-.33H19.5a2.25 2.25 0 012.25 2.25v10.5a2.25 2.25 0 01-2.25 2.25h-9.284c-.298 0-.585-.119-.796-.33z" />
                </svg>
                <span class="text-xl font-bold text-gray-900">Meet the Masters</span>
            </div>
            <nav id="desktop-nav" class="mt-5 flex-1 px-2 space-y-1"></nav>
        </div>
        <div class="flex-shrink-0 flex border-t border-gray-200 p-4">
            <p class="text-xs text-gray-500">Â© 2024 Oak Meadow Foundation</p>
        </div>
    </aside>

    <div class="flex flex-col w-0 flex-1 overflow-hidden bg-gray-50">
        <header class="md:hidden relative bg-white flex-shrink-0">
            <div class="flex items-center justify-between border-b border-gray-200 px-4 py-3">
                <div class="flex items-center">
                    <svg class="h-6 w-6 text-blue-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9.75L14.25 12m0 0l2.25 2.25M14.25 12l2.25-2.25M14.25 12L12 14.25m-2.58 4.92l-6.375-6.375a1.125 1.125 0 010-1.59L9.42 4.83c.211-.211.498-.33.796-.33H19.5a2.25 2.25 0 012.25 2.25v10.5a2.25 2.25 0 01-2.25 2.25h-9.284c-.298 0-.585-.119-.796-.33z" />
                    </svg>
                    <span class="text-lg font-bold text-gray-900">Meet the Masters</span>
                </div>
                <button id="mobile-menu-button" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-500 hover:text-gray-900 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                    <span class="sr-only">Open main menu</span>
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>
            </div>
        </header>

        <div id="mobile-sidebar" class="hidden md:hidden" role="dialog" aria-modal="true">
            <div id="mobile-sidebar-backdrop" class="fixed inset-0 bg-gray-600 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <div class="fixed inset-0 flex z-40">
                <div id="mobile-sidebar-panel" class="relative flex-1 flex flex-col max-w-xs w-full bg-white pt-5 pb-4 transform -translate-x-full">
                    <div class="absolute top-0 right-0 -mr-12 pt-2">
                        <button id="mobile-menu-close-button" type="button" class="ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white">
                            <span class="sr-only">Close sidebar</span>
                            <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center flex-shrink-0 px-4">
                        <span class="text-xl font-bold text-gray-900">Navigation</span>
                    </div>
                    <div class="mt-5 flex-1 h-0 overflow-y-auto">
                        <nav id="mobile-nav" class="px-2 space-y-1"></nav>
                    </div>
                </div>
                <div class="flex-shrink-0 w-14" aria-hidden="true"></div>
            </div>
        </div>

        <main id="main-content" class="flex-1 relative overflow-y-auto focus:outline-none">
        </main>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, getDocs, addDoc, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Use the global variables provided by the Canvas environment
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- FIREBASE SERVICES ---
    let app, auth, db, eventsCollectionRef;
    let isAuthReady = false;
    let allEventsCache = [];

    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        // Correctly use appId from firebaseConfig in the collection path
        eventsCollectionRef = collection(db, `/artifacts/${appId}/public/data/events`);
    } catch (e) {
        console.error("Firebase initialization failed:", e);
        // Display user-friendly error message on the page
        document.getElementById('main-content').innerHTML = `<div class="p-8 text-center text-red-500"><h1 class="text-2xl font-bold">Error</h1><p>Could not connect to the application services. Please ensure your Firebase configuration is correct and try again later.</p><p class="text-sm mt-4">Details: ${e.message}</p></div>`;
    }

    // --- AUTHENTICATION ---
    async function setupAuth() {
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
            isAuthReady = true;
            console.log("Authentication successful. User UID:", auth.currentUser.uid);
        } catch (error) {
            console.error("Authentication failed:", error);
            // Optionally, show a notification or message for auth failure
        }
    }

    // --- DATA ---
    const tracks = [
        { id: 'a', name: 'Track A', artists: [
            { id: 'monet', name: 'Claude Monet', era: 'Impressionism', image: 'https://placehold.co/400x300/60a5fa/1e40af?text=Monet', focus: 'Light & Color' },
            { id: 'vangogh', name: 'Vincent van Gogh', era: 'Post-Impressionism', image: 'https://placehold.co/400x300/facc15/b45309?text=Van+Gogh', focus: 'Texture & Emotion' },
            { id: 'picasso', name: 'Pablo Picasso', era: 'Cubism', image: 'https://placehold.co/400x300/f87171/991b1b?text=Picasso', focus: 'Shape & Form' },
            { id: 'homer', name: 'Winslow Homer', era: 'Realism', image: 'https://placehold.co/400x300/38bdf8/0c4a6e?text=Homer', focus: 'Seascapes' },
            { id: 'cassatt', name: 'Mary Cassatt', era: 'Impressionism', image: 'https://placehold.co/400x300/f472b6/831843?text=Cassatt', focus: 'Everyday Life' },
        ]},
        { id: 'b', name: 'Track B', artists: [
            { id: 'remington', name: 'Frederic Remington', era: 'American West', image: 'https://placehold.co/400x300/a3e635/3f6212?text=Remington', focus: 'Western Art' },
            { id: 'okeefe', name: 'Georgia O\'Keeffe', era: 'American Modernism', image: 'https://placehold.co/400x300/f9a8d4/831843?text=O\'Keeffe', focus: 'Composition & Scale' },
            { id: 'hokusai', name: 'Katsushika Hokusai', era: 'Ukiyo-e', image: 'https://placehold.co/400x300/2dd4bf/134e4a?text=Hokusai', focus: 'Woodblock Prints' },
            { id: 'matisse', name: 'Henri Matisse', era: 'Fauvism', image: 'https://placehold.co/400x300/fb7185/881337?text=Matisse', focus: 'Bold Color' },
            { id: 'degas', name: 'Edgar Degas', era: 'Impressionism', image: 'https://placehold.co/400x300/c084fc/581c87?text=Degas', focus: 'Movement' },
            { id: 'kahlo', name: 'Frida Kahlo', era: 'Surrealism', image: 'https://placehold.co/400x300/f0abfc/701a75?text=Frida', focus: 'Self-Portraiture' },
            { id: 'wyeth', name: 'Andrew Wyeth', era: 'Realism', image: 'https://placehold.co/400x300/d4d4d4/404040?text=Wyeth', focus: 'Rural American Life' },
        ]},
        { id: 'c', name: 'Track C', artists: [
            { id: 'miro', name: 'Joan MirÃ³', era: 'Surrealism', image: 'https://placehold.co/400x300/a78bfa/5b21b6?text=MirÃ³', focus: 'Biomorphic Shapes' },
            { id: 'rembrandt', name: 'Rembrandt', era: 'Baroque', image: 'https://placehold.co/400x300/f59e0b/78350f?text=Rembrandt', focus: 'Chiaroscuro' },
            { id: 'bonheur', name: 'Rosa Bonheur', era: 'Realism', image: 'https://placehold.co/400x300/6ee7b7/047857?text=Bonheur', focus: 'Animal Painting' },
            { id: 'lawrence', name: 'Jacob Lawrence', era: 'Modern American', image: 'https://placehold.co/400x300/bae6fd/0369a1?text=Lawrence', focus: 'Narrative Series' },
            { id: 'calder', name: 'Alexander Calder', era: 'Modern Sculpture', image: 'https://placehold.co/400x300/fca5a5/7f1d1d?text=Calder', focus: 'Mobiles & Stabiles' },
            { id: 'gauguin', name: 'Paul Gauguin', era: 'Post-Impressionism', image: 'https://placehold.co/400x300/fbcfe8/be185d?text=Gauguin', focus: 'Symbolism & Color' },
            { id: 'toulouse-lautrec', name: 'Henri de Toulouse-Lautrec', era: 'Post-Impressionism', image: 'https://placehold.co/400x300/c4b5fd/6d28d9?text=Toulouse-Lautrec', focus: 'Poster Art' },
        ]},
        { id: 'd', name: 'Track D', artists: [
            { id: 'cezanne', name: 'Paul CÃ©zanne', era: 'Post-Impressionism', image: 'https://placehold.co/400x300/a5b4fc/4338ca?text=CÃ©zanne', focus: 'Geometric Forms' },
            { id: 'renoir', name: 'Pierre-Auguste Renoir', era: 'Impressionism', image: 'https://placehold.co/400x300/f472b6/831843?text=Renoir', focus: 'Figures & Light' },
            { id: 'chagall', name: 'Marc Chagall', era: 'Cubism / Surrealism', image: 'https://placehold.co/400x300/fcd34d/b45309?text=Chagall', focus: 'Symbolic Imagery' },
            { id: 'klee', name: 'Paul Klee', era: 'Expressionism', image: 'https://placehold.co/400x300/818cf8/312e81?text=Klee', focus: 'Abstract Shapes' },
            { id: 'davinci', name: 'Leonardo da Vinci', era: 'High Renaissance', image: 'https://placehold.co/400x300/93c5fd/1e40af?text=Da+Vinci', focus: 'Anatomy & Invention' },
            { id: 'seurat', name: 'Georges Seurat', era: 'Pointillism', image: 'https://placehold.co/400x300/a78bfa/5b21b6?text=Seurat', focus: 'Dotted Color' },
            { id: 'ringgold', name: 'Faith Ringgold', era: 'Contemporary', image: 'https://placehold.co/400x300/fbcfe8/be185d?text=Ringgold', focus: 'Story Quilts' },
        ]},
        { id: 'e', name: 'Track E', artists: [
            { id: 'warhol', name: 'Andy Warhol', era: 'Pop Art', image: 'https://placehold.co/400x300/a3e635/3f6212?text=Warhol', focus: 'Repetition & Consumerism' },
            { id: 'hopper', name: 'Edward Hopper', era: 'American Realism', image: 'https://placehold.co/400x300/38bdf8/0c4a6e?text=Hopper', focus: 'Urban Isolation' },
            { id: 'rockwell', name: 'Norman Rockwell', era: 'American Realism', image: 'https://placehold.co/400x300/dbeafe/1e3a8a?text=Rockwell', focus: 'Everyday Life' },
            { id: 'rousseau', name: 'Henri Rousseau', era: 'NaÃ¯ve Art', image: 'https://placehold.co/400x300/c084fc/581c87?text=Rousseau', focus: 'Jungle Scenes' },
            { id: 'klimt', name: 'Gustav Klimt', era: 'Symbolism / Art Nouveau', image: 'https://placehold.co/400x300/fb7185/881337?text=Klimt', focus: 'Gold Leaf & Patterns' },
            { id: 'michelangelo', name: 'Michelangelo', era: 'High Renaissance', image: 'https://placehold.co/400x300/fca5a5/7f1d1d?text=Michelangelo', focus: 'Sculpture & Fresco' },
            { id: 'martinez', name: 'Maria Martinez', era: 'Native American Pottery', image: 'https://placehold.co/400x300/f0abfc/701a75?text=Martinez', focus: 'Pueblo Pottery' },
        ]},
    ];
    function findArtist(artistId) {
        for (const track of tracks) {
            const artist = track.artists.find(a => a.id === artistId);
            if (artist) return artist;
        }
        return null;
    }

    // --- UI ELEMENTS ---
    const mainContent = document.getElementById('main-content');
    const desktopNav = document.getElementById('desktop-nav');
    const mobileNav = document.getElementById('mobile-nav');
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenuCloseButton = document.getElementById('mobile-menu-close-button');
    const mobileSidebar = document.getElementById('mobile-sidebar');
    const mobileSidebarBackdrop = document.getElementById('mobile-sidebar-backdrop');
    const mobileSidebarPanel = document.getElementById('mobile-sidebar-panel');

    let currentRoute = { page: 'home', params: {} };
    let eventsUnsubscribe = null;

    const pages = [
        { id: 'home', title: 'Home', icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5"/>` },
        { id: 'artists', title: 'Meet the Artists', icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />` },
        { id: 'materials', title: 'Volunteer Resources', icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />` },
        { id: 'schedule', title: 'Schedule & Sign-up', icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M12 12.75h.008v.008H12v-.008z" />` },
        { id: 'gallery', title: 'Student Art Gallery', icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />` },
        { id: 'admin', title: 'Admin', icon: `<path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-1.007 1.11-1.227l.473-.236A2.25 2.25 0 0114.25 2.25h1.5a2.25 2.25 0 012.25 2.25v1.5c0 .336.1.662.296.932l.473.631c.39.523.632 1.148.632 1.807v1.5c0 .659-.242 1.284-.632 1.807l-.473.631a2.25 2.25 0 01-.296.932v1.5a2.25 2.25 0 01-2.25-2.25h-1.5a2.25 2.25 0 01-1.407-.584l-.473-.355a2.253 2.253 0 00-1.11-1.227c-.528-.22-1.135-.22-1.664 0l-.473.236a2.25 2.25 0 01-1.407.584h-1.5a2.25 2.25 0 01-2.25-2.25v-1.5c0-.336-.1-.662-.296-.932l-.473-.631c-.39-.523-.632-1.148-.632-1.807v-1.5c0-.659.242-1.284.632-1.807l.473-.631a2.25 2.25 0 01.296-.932v-1.5a2.25 2.25 0 012.25-2.25h1.5a2.25 2.25 0 011.407.584l.473.355c.529.398 1.135.398 1.664 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />` }
    ];

    // --- NAVIGATION & ROUTING ---
    function updateNavLinks(activePageId) {
        const navHtml = pages.map(page => {
            const isActive = page.id === activePageId;
            const activeClass = 'bg-blue-50 text-blue-600';
            const inactiveClass = 'text-gray-600 hover:bg-gray-100 hover:text-gray-900';
            return `<a href="#" data-page='${page.id}' class="nav-link ${isActive ? activeClass : inactiveClass} group flex items-center px-2 py-2 text-sm font-medium rounded-md"><svg class="mr-3 flex-shrink-0 h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">${page.icon}</svg>${page.title}</a>`;
        }).join('');
        desktopNav.innerHTML = navHtml;
        mobileNav.innerHTML = navHtml;
        document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', (e) => {
            e.preventDefault();
            loadPage({ page: e.currentTarget.dataset.page });
        }));
    }

    function loadPage(route){
        currentRoute = route;
        renderPage(currentRoute);
        updateNavLinks(currentRoute.page);
        window.scrollTo(0, 0);
        if (!mobileSidebar.classList.contains('hidden')) closeMobileMenu();
    }

    // --- PAGE RENDERING ---
    function renderPage(route) {
        mainContent.classList.add('content-fade-enter');
        if (eventsUnsubscribe) { eventsUnsubscribe(); eventsUnsubscribe = null; }

        let content;
        switch (route.page) {
            case 'home': content = generateHomePage(); break;
            case 'artists':
                if (route.params && route.params.artistId) {
                    content = generateArtistDetailPage(route.params.artistId);
                } else {
                    content = generateArtistsPage();
                }
                break;
            case 'materials': content = generateMaterialsPage(); break;
            case 'schedule': generateSchedulePage(); return; // Schedule page handles its own content injection
            case 'gallery': content = generateGalleryPage(); break;
            case 'admin': generateAdminPage(); return; // Admin page handles its own content injection
            default: content = generateHomePage();
        }

        // Only inject HTML directly if the page doesn't handle it itself (like schedule/admin)
        if (route.page !== 'schedule' && route.page !== 'admin') {
            mainContent.innerHTML = `<div class="py-6"><div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8">${content}</div></div>`;
            attachContentEventListeners(); // Attach listeners after content is in DOM
        }


        setTimeout(() => mainContent.classList.add('content-fade-enter-active'), 10);
        setTimeout(() => mainContent.classList.remove('content-fade-enter', 'content-fade-enter-active'), 300);
    }

    // --- CONTENT TEMPLATES ---
    function generateHomePage() { return `<div class="bg-white rounded-lg shadow-lg p-8 mb-8"><div class="text-center"><h1 class="text-4xl md:text-5xl font-bold text-blue-900 tracking-tight">Bringing Art to Life in Our Classrooms</h1><p class="mt-4 max-w-2xl mx-auto text-lg text-gray-600">The Meet the Masters program introduces students to the world's greatest artists through engaging presentations, hands-on projects, and the help of dedicated volunteers like you.</p></div></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"><div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:-translate-y-1 transition-transform duration-300"><img class="h-48 w-full object-cover" src="https://placehold.co/400x300/dbeafe/1e3a8a?text=Volunteers" alt="Volunteers" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e0e7ff/4338ca?text=Image+Missing';"><div class="p-6"><h3 class="text-xl font-bold text-gray-900">Volunteer With Us</h3><p class="mt-2 text-gray-600">No art background? No problem! We provide training, scripts, and all the materials you need to inspire young artists.</p><div class="mt-4"><button data-page="schedule" class="page-link text-blue-600 font-semibold hover:text-blue-800">View Schedule &rarr;</button></div></div></div><div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:-translate-y-1 transition-transform duration-300"><img class="h-48 w-full object-cover" src="https://placehold.co/400x300/e0e7ff/4338ca?text=Program+Info" alt="Program Info" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e0e7ff/4338ca?text=Image+Missing';"><div class="p-6"><h3 class="text-xl font-bold text-gray-900">Our Program</h3><p class="mt-2 text-gray-600">Learn about our 3-step approach: introducing the masters, discovering techniques, and creating original artwork.</p><div class="mt-4"><button data-page="artists" class="page-link text-blue-600 font-semibold hover:text-blue-800">Learn More &rarr;</button></div></div></div><div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:-translate-y-1 transition-transform duration-300"><img class="h-48 w-full object-cover" src="https://placehold.co/400x300/c7d2fe/3730a3?text=Art+Gallery" alt="Art Gallery" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e0e7ff/4338ca?text=Image+Missing';"><div class="p-6"><h3 class="text-xl font-bold text-gray-900">Student Gallery</h3><p class="mt-2 text-gray-600">See the amazing artwork our students have created, inspired by the masters.</p><div class="mt-4"><button data-page="gallery" class="page-link text-blue-600 font-semibold hover:text-blue-800">View Gallery &rarr;</button></div></div></div></div>`; }
    function generateArtistsPage() {
        const tracksHtml = tracks.map(track => {
            if (track.artists.length === 0) {
                return `
                    <div class="bg-white rounded-lg shadow-md mb-6">
                        <button class="w-full p-4 text-left bg-gray-100 rounded-t-lg font-bold text-lg text-gray-500 cursor-default">
                            ${track.name}
                        </button>
                        <div class="p-4 text-gray-500">Coming Soon</div>
                    </div>
                `;
            }

            const artistListHtml = track.artists.map(artist => `
                <a href="#" data-page="artists" data-artist-id="${artist.id}" class="page-link block p-4 -mx-4 rounded-md hover:bg-gray-100">
                    <div class="flex items-center gap-4">
                         <img class="h-12 w-12 rounded-full object-cover" src="${artist.image}" alt="${artist.name}" onerror="this.onerror=null;this.src='https://placehold.co/48x48/e0e7ff/4338ca?text=A';">
                         <div>
                            <p class="font-semibold text-gray-800">${artist.name}</p>
                            <p class="text-sm text-gray-500">${artist.era}</p>
                         </div>
                    </div>
                </a>
            `).join('');

            return `
                <div class="bg-white rounded-lg shadow-md mb-6">
                    <button class="accordion-toggle w-full p-4 text-left bg-gray-100 hover:bg-gray-200 transition rounded-t-lg font-bold text-lg text-gray-800 flex justify-between items-center">
                        ${track.name}
                        <svg class="accordion-arrow h-6 w-6 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div class="accordion-content">
                        <div class="p-4 space-y-2">${artistListHtml}</div>
                    </div>
                </div>
            `;
        }).join('');
        return `<h1 class="text-3xl font-bold text-gray-900 mb-6">Artist Tracks</h1><div class="space-y-4">${tracksHtml}</div>`;
    }
    function generateArtistDetailPage(artistId) {
        const artist = findArtist(artistId);
        if (!artist) return `<h1 class="text-3xl font-bold text-gray-900 mb-6">Artist Not Found</h1><button class="page-link" data-page="artists"> &larr; Back to Artists</button>`;

        const levels = ['Beginning', 'Intermediate', 'Advanced'];
        const tabsHtml = levels.map((level, index) => `
            <a href="#" data-level="${level.toLowerCase()}" class="level-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${index === 0 ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">
              ${level}
            </a>
        `).join('');

        return `
            <div class="mb-6">
                <button class="page-link text-blue-600 hover:underline" data-page="artists">&larr; Back to All Artists</button>
            </div>
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="lg:w-1/3 flex-shrink-0">
                     <img class="w-full rounded-lg shadow-lg" src="${artist.image}" alt="${artist.name}" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e0e7ff/4338ca?text=Image';">
                     <h1 class="text-4xl font-bold text-gray-900 mt-4">${artist.name}</h1>
                     <p class="text-lg text-gray-500">${artist.era}</p>
                </div>
                <div class="flex-grow">
                    <div class="border-b border-gray-200">
                       <nav class="-mb-px flex space-x-8" aria-label="Tabs">${tabsHtml}</nav>
                    </div>
                    <div id="level-content-container" class="mt-6">
                        ${generateLevelContent(artist, 'beginning')}
                    </div>
                </div>
            </div>
        `;
    }
    function generateLevelContent(artist, level) {
        return `
            <div class="space-y-8">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">1. Introducing the Master: Art & History Slideshow (${level})</h2>
                    <p class="text-gray-600 mb-4">Explore a visual journey through ${artist.name}'s life and iconic artwork, accompanied by historical context.</p>
                    <button class="w-full text-left p-4 bg-blue-50 rounded-lg hover:bg-blue-100 transition">
                        <span class="font-semibold text-blue-800">â¶ï¸ View ${level} Slideshow</span>
                    </button>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">2. Learning from the Master: Artist History PDF (${level})</h2>
                    <p class="text-gray-600 mb-4">Download a detailed PDF document covering the complete history of ${artist.name} and their artistic journey.</p>
                     <button class="w-full text-left p-4 bg-purple-50 rounded-lg hover:bg-purple-100 transition mt-2">
                        <span class="font-semibold text-purple-800">ð Download ${level} Artist History PDF</span>
                    </button>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">3. Working with the Master: Art Project Training Video (${level})</h2>
                    <p class="text-gray-600 mb-4">Watch a step-by-step training video guiding you through the art project inspired by ${artist.name}'s techniques at the ${level} level.</p>
                     <button class="w-full text-left p-4 bg-green-50 rounded-lg hover:bg-green-100 transition mt-2">
                        <span class="font-semibold text-green-800">ð¬ View ${level} Art Project Training Video</span>
                    </button>
                </div>
            </div>
        `;
    }
    function generateMaterialsPage() { return `<h1 class="text-3xl font-bold text-gray-900 mb-6">Volunteer Resources</h1><div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg mb-8" role="alert"><p class="font-bold">Welcome, Volunteers!</p><p>This is your hub for all general lesson plans, training videos, and classroom materials. Thank you for making this program possible!</p></div><div class="space-y-8"><div><h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Core Training</h5><ul class="list-disc list-inside space-y-2 text-gray-700"><li><a href="#" class="text-blue-600 hover:underline">Program Overview & Volunteer Handbook (.pdf)</a></li><li><a href="#" class="text-blue-600 hover:underline">Classroom Management Tips for Art Sessions (Video)</a></li><li><a href="#" class="text-blue-600 hover:underline">How to Use the 3-Step Method (Video)</a></li></ul></div><div><h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Art Supply Lists</h5><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><a href="#" class="block p-4 bg-white rounded-lg shadow hover:shadow-lg transition-shadow">Kindergarten Supply List</a><a href="#" class="block p-4 bg-white rounded-lg shadow hover:shadow-lg transition-shadow">1st-2nd Grade Supply List</a><a href="#" class="block p-4 bg-white rounded-lg shadow hover:shadow-lg transition-shadow">3rd-5th Grade Supply List</a></div></div></div>`; }
    function generateGalleryPage() { const artworks=[{title:"Starry Night Interpretation",artist:"Emily, Grade 3",image:"https://placehold.co/600x400/0c4a6e/f0f9ff?text=Student+Artwork+1"},{title:"My Cubist Friend",artist:"Leo, Grade 5",image:"https://placehold.co/600x400/7c2d12/fef3c7?text=Student+Artwork+2"},{title:"Water Lilies at Sunrise",artist:"Mia, Grade 2",image:"https://placehold.co/600x400/166534/f0fdf4?text=Student+Artwork+3"},{title:"Pop Art Can",artist:"David, Grade 4",image:"https://placehold.co/600x400/7e22ce/f3e8ff?text=Student+Artwork+4"}];let artCards=artworks.map(art=>`<div class="bg-white rounded-lg shadow-lg overflow-hidden"><img src="${art.image}" alt="${art.title}" class="w-full h-64 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/4b5563/ffffff?text=Image+Error';"><div class="p-4"><h3 class="font-bold text-gray-900">${art.title}</h3><p class="text-gray-600 text-sm">by ${art.artist}</p></div></div>`).join("");return `<h1 class="text-3xl font-bold text-gray-900 mb-6">Student Art Gallery</h1><p class="text-gray-600 mb-6">Celebrating the creativity of our young artists! Here is a selection of works from recent classroom sessions.</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-8">${artCards}</div>`; }

    // --- EVENT LISTENERS ---
    function attachContentEventListeners() {
        document.querySelectorAll('.page-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = e.currentTarget.dataset.page;
                const artistId = e.currentTarget.dataset.artistId;
                const route = { page: page, params: artistId ? { artistId: artistId } : {} };
                loadPage(route);
            });
        });

        document.querySelectorAll('.accordion-toggle').forEach(button => {
            button.addEventListener('click', () => {
                const content = button.nextElementSibling;
                const arrow = button.querySelector('.accordion-arrow');
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                    arrow.classList.remove('rotate-180');
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                    arrow.classList.add('rotate-180');
                }
            });
        });

        document.querySelectorAll('.level-tab').forEach(t => {
            t.addEventListener('click', (e) => {
                e.preventDefault();
                const artist = findArtist(currentRoute.params.artistId);
                const level = e.currentTarget.dataset.level;

                document.querySelectorAll('.level-tab').forEach(tab => {
                    tab.classList.remove('border-blue-500', 'text-blue-600');
                    tab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                });
                e.currentTarget.classList.add('border-blue-500', 'text-blue-600');
                e.currentTarget.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

                document.getElementById('level-content-container').innerHTML = generateLevelContent(artist, level);
            });
        });
    }

    // --- SCHEDULE PAGE ---
    function generateSchedulePage() {
        const container = document.createElement('div');
        container.className = 'py-6';
        container.innerHTML = `<div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8"><h1 class="text-3xl font-bold text-gray-900 mb-2">Schedule & Sign-up</h1><p class="text-gray-600 mb-6">Find training dates and sign up to help in a classroom. Your help makes all the difference!</p><div id="event-list" class="space-y-4"><div class="text-center py-8"><p class="text-gray-500">Loading schedule...</p></div></div></div>`;
        mainContent.innerHTML = ''; // Clear previous content
        mainContent.appendChild(container);
        waitForAuthAndLoad(setupScheduleListener);
    }

    function setupScheduleListener() {
        // Ensure db is initialized before trying to use eventsCollectionRef
        if (!db || !eventsCollectionRef) {
            console.error("Firestore is not initialized for schedule listener.");
            document.getElementById('event-list').innerHTML = `<p class="text-center text-red-500 py-8">Application services not available. Please refresh or check console for errors.</p>`;
            return;
        }

        eventsUnsubscribe = onSnapshot(eventsCollectionRef, (snapshot) => {
            const eventList = document.getElementById('event-list');
            if (snapshot.empty) {
                 eventList.innerHTML = `<p class="text-center text-gray-500 py-8">No events scheduled yet. Check back soon!</p>`;
                 seedDatabaseWithInitialEvents(); // Attempt to seed if empty
                 return;
            }
            allEventsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderPublicEvents(allEventsCache);
        }, (error) => {
            console.error("Error fetching events:", error);
            document.getElementById('event-list').innerHTML = `<p class="text-center text-red-500 py-8">Error loading schedule. Please try refreshing the page.</p>`;
        });
    }

    function renderPublicEvents(events) {
        const eventList = document.getElementById('event-list');
        if (!eventList) return;
        const userId = auth.currentUser ? auth.currentUser.uid : null;
        eventList.innerHTML = events.map(e => {
            const isFull = e.filled >= e.slots;
            const isSignedUp = userId && e.attendees && e.attendees.includes(userId);
            const percentage = e.slots > 0 ? (e.filled / e.slots) * 100 : 0;
            let buttonHtml;
            if (isSignedUp) {
                buttonHtml = `<button class="w-full px-4 py-2 text-sm font-semibold text-white rounded-md bg-green-600 cursor-default" disabled>Signed Up!</button>`;
            } else if (isFull) {
                buttonHtml = `<button class="w-full px-4 py-2 text-sm font-semibold text-white rounded-md bg-gray-400 cursor-not-allowed" disabled>Full</button>`;
            } else {
                buttonHtml = `<button data-event-id="${e.id}" class="signup-btn w-full px-4 py-2 text-sm font-semibold text-white rounded-md transition-colors bg-blue-600 hover:bg-blue-700">Sign Up</button>`;
            }
            return `<div class="bg-white p-4 rounded-lg shadow flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4"><div class="flex-grow"><div class="flex items-center gap-3 mb-2"><span class="px-2 py-1 text-xs font-semibold rounded-full ${e.type==='Training' ? 'bg-purple-100 text-purple-800' : e.type==='Art Session' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">${e.type}</span><p class="text-sm text-gray-500">${e.date} &bull; ${e.time}</p></div><h3 class="font-bold text-lg text-gray-900">${e.title}</h3><p class="text-sm text-gray-600">Location: ${e.location} ${e.role ? `(${e.role})` : ''}</p></div><div class="w-full sm:w-auto flex-shrink-0"><div class="flex items-center gap-2 text-sm text-gray-600 mb-1"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41-1.412A9.957 9.957 0 0010 18c2.31 0 4.438-.784 6.131-2.095a1.23 1.23 0 00.41-1.412A9.992 9.992 0 0010 12c-2.31 0-4.438.784-6.131 2.095z" /></svg><span>${e.filled} / ${e.slots} filled</span></div><div class="w-full bg-gray-200 rounded-full h-2.5 mb-2"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${percentage}%"></div></div>${buttonHtml}</div></div>`;
        }).join('');
        document.querySelectorAll('.signup-btn').forEach(button => button.addEventListener('click', handleSignUp));
    }

    async function handleSignUp(e) {
        const eventId = e.target.dataset.eventId;
        const userId = auth.currentUser.uid;
        if (!userId) {
            showNotification('Authentication Required', 'Please refresh the page to sign up.', 'error');
            return;
        }
        e.target.disabled = true; e.target.textContent = 'Signing up...';
        try {
            await runTransaction(db, async (transaction) => {
                const eventDocRef = doc(db, `/artifacts/${appId}/public/data/events`, eventId);
                const eventDoc = await transaction.get(eventDocRef);
                if (!eventDoc.exists()) throw new Error("Event does not exist!");

                const eventData = eventDoc.data();
                const attendees = eventData.attendees || [];

                if (eventData.filled >= eventData.slots) throw new Error("Event is full.");
                if (attendees.includes(userId)) throw new Error("Already signed up.");

                const newFilledCount = eventData.filled + 1;
                const newAttendees = [...attendees, userId];
                transaction.update(eventDocRef, { filled: newFilledCount, attendees: newAttendees });
            });
            showNotification('Success!', 'You have successfully signed up for the event.', 'success');
        } catch (error) {
            console.error("Sign up failed:", error);
            showNotification('Sign-up Failed', error.message || 'Could not sign you up. Please try again.', 'error');
            setTimeout(() => { if(e.target) { e.target.disabled = false; e.target.textContent = 'Sign Up'; } }, 2000);
        }
    }

    // --- ADMIN PAGE ---
    function generateAdminPage() {
        const container = document.createElement('div');
        container.className = 'py-6';
        container.innerHTML = `<div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8"><h1 class="text-3xl font-bold text-gray-900 mb-6">Admin Panel</h1><div class="bg-white p-6 rounded-lg shadow mb-8"><h2 id="admin-form-title" class="text-2xl font-bold text-gray-800 mb-4">Add New Event</h2><form id="admin-event-form" class="grid grid-cols-1 gap-6 sm:grid-cols-2"><input type="hidden" id="event-id"><div class="sm:col-span-2"><label for="event-title" class="form-label">Event Title</label><input type="text" id="event-title" class="form-input" required></div><div><label for="event-date" class="form-label">Date</label><input type="date" id="event-date" class="form-input" required></div><div><label for="event-time" class="form-label">Time</label><input type="text" id="event-time" placeholder="e.g., 7:00pm - 8:00pm" class="form-input" required></div><div><label for="event-location" class="form-label">Location</label><input type="text" id="event-location" class="form-input" required></div><div><label for="event-slots" class="form-label">Volunteer Slots</label><input type="number" id="event-slots" value="1" min="0" class="form-input" required></div><div class="sm:col-span-2"><label for="event-type" class="form-label">Event Type</label><select id="event-type" class="form-input"><option>Art Session</option><option>Training</option><option>Event</option></select></div><div class="sm:col-span-2 text-right"><button type="button" id="cancel-edit-btn" class="hidden mr-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50">Cancel</button><button type="submit" id="submit-event-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md shadow-sm hover:bg-blue-700">Add Event</button></div></form></div><h2 class="text-2xl font-bold text-gray-800 mb-4">Manage Events</h2><div id="admin-event-list" class="space-y-4 bg-white p-4 rounded-lg shadow"><div class="text-center py-8"><p class="text-gray-500">Loading events...</p></div></div></div>`;
        mainContent.innerHTML = ''; // Clear previous content
        mainContent.appendChild(container);
        attachAdminFormListeners();
        waitForAuthAndLoad(setupAdminListener);
    }

    function setupAdminListener() {
        // Ensure db is initialized before trying to use eventsCollectionRef
        if (!db || !eventsCollectionRef) {
            console.error("Firestore is not initialized for admin listener.");
            document.getElementById('admin-event-list').innerHTML = `<p class="text-center text-red-500 py-8">Application services not available. Please refresh or check console for errors.</p>`;
            return;
        }

         eventsUnsubscribe = onSnapshot(eventsCollectionRef, (snapshot) => {
            const adminEventList = document.getElementById('admin-event-list');
             if (snapshot.empty) {
                 adminEventList.innerHTML = `<p class="text-center text-gray-500 py-8">No events found.</p>`;
                 return;
             }
            allEventsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAdminEvents(allEventsCache);
        }, (error) => {
            console.error("Error fetching admin events:", error);
            document.getElementById('admin-event-list').innerHTML = `<p class="text-center text-red-500 py-8">Error loading events.</p>`;
        });
    }

    function renderAdminEvents(events) {
        const listEl = document.getElementById('admin-event-list');
        if (!listEl) return;
        listEl.innerHTML = events.map(e => `
            <div class="p-3 border rounded-md flex items-center justify-between hover:bg-gray-50">
                <div>
                    <p class="font-bold text-gray-800">${e.title}</p>
                    <p class="text-sm text-gray-500">${e.date} | ${e.location} | ${e.filled}/${e.slots} filled</p>
                </div>
                <div class="flex-shrink-0 space-x-2">
                    <button data-event-id="${e.id}" class="edit-btn px-3 py-1 text-sm font-medium text-blue-600 bg-blue-100 rounded-md hover:bg-blue-200">Edit</button>
                    <button data-event-id="${e.id}" class="delete-btn px-3 py-1 text-sm font-medium text-red-600 bg-red-100 rounded-md hover:bg-red-200">Delete</button>
                </div>
            </div>
        `).join('');

        document.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', handleEditEvent));
        document.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', handleDeleteEvent));
    }

    function attachAdminFormListeners() {
        const form = document.getElementById('admin-event-form');
        const cancelBtn = document.getElementById('cancel-edit-btn');
        if(form) form.addEventListener('submit', handleFormSubmit);
        if(cancelBtn) cancelBtn.addEventListener('click', resetAdminForm);
    }

    async function handleFormSubmit(e) {
        e.preventDefault();

        // Check if db is initialized
        if (!db) {
            showNotification('Error', 'Application services not ready. Please refresh.', 'error');
            return;
        }

        const eventId = document.getElementById('event-id').value;
        const eventData = {
            title: document.getElementById('event-title').value,
            date: document.getElementById('event-date').value,
            time: document.getElementById('event-time').value,
            location: document.getElementById('event-location').value,
            slots: parseInt(document.getElementById('event-slots').value, 10),
            type: document.getElementById('event-type').value,
        };

        const submitBtn = document.getElementById('submit-event-btn');
        if(submitBtn) submitBtn.disabled = true;

        try {
            if (eventId) { // Update existing event
                if(submitBtn) submitBtn.textContent = 'Updating...';
                const eventDocRef = doc(db, `/artifacts/${appId}/public/data/events`, eventId);
                await updateDoc(eventDocRef, eventData);
                showNotification('Success', 'Event updated successfully.', 'success');
            } else { // Add new event
                if(submitBtn) submitBtn.textContent = 'Adding...';
                eventData.filled = 0;
                eventData.attendees = [];
                await addDoc(eventsCollectionRef, eventData);
                showNotification('Success', 'Event added successfully.', 'success');
            }
            resetAdminForm();
        } catch (error) {
            console.error("Error submitting form:", error);
            showNotification('Error', 'There was a problem saving the event: ' + (error.message || 'Unknown error'), 'error');
        } finally {
            if(submitBtn) submitBtn.disabled = false;
        }
    }

    function handleEditEvent(e) {
        const eventId = e.target.dataset.eventId;
        const event = allEventsCache.find(ev => ev.id === eventId);
        if (!event) {
            showNotification('Error', 'Event not found for editing.', 'error');
            return;
        }

        document.getElementById('admin-form-title').textContent = 'Edit Event';
        document.getElementById('event-id').value = event.id;
        document.getElementById('event-title').value = event.title;
        document.getElementById('event-date').value = event.date;
        document.getElementById('event-time').value = event.time;
        document.getElementById('event-location').value = event.location;
        document.getElementById('event-slots').value = event.slots;
        document.getElementById('event-type').value = event.type;

        document.getElementById('submit-event-btn').textContent = 'Update Event';
        document.getElementById('cancel-edit-btn').classList.remove('hidden');

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function handleDeleteEvent(e) {
        const eventId = e.target.dataset.eventId;
        const button = e.target;
        if (button.textContent !== 'Confirm?') {
            button.textContent = 'Confirm?';
            button.classList.add('bg-yellow-300', 'hover:bg-yellow-400');
            setTimeout(() => {
                if (button && button.textContent === 'Confirm?') { // Only revert if not clicked again
                    button.textContent = 'Delete';
                    button.classList.remove('bg-yellow-300', 'hover:bg-yellow-400');
                }
            }, 3000);
            return;
        }

        // Check if db is initialized
        if (!db) {
            showNotification('Error', 'Application services not ready. Cannot delete event.', 'error');
            return;
        }

        try {
            await deleteDoc(doc(db, `/artifacts/${appId}/public/data/events`, eventId));
            showNotification('Success', 'Event deleted.', 'success');
        } catch (error) {
            console.error("Error deleting event:", error);
            showNotification('Error', 'Failed to delete event: ' + (error.message || 'Unknown error'), 'error');
        }
    }

    function resetAdminForm() {
        const form = document.getElementById('admin-event-form');
        if(form) form.reset();

        const title = document.getElementById('admin-form-title');
        if(title) title.textContent = 'Add New Event';

        const eventIdInput = document.getElementById('event-id');
        if(eventIdInput) eventIdInput.value = '';

        const submitBtn = document.getElementById('submit-event-btn');
        if(submitBtn) submitBtn.textContent = 'Add Event';

        const cancelBtn = document.getElementById('cancel-edit-btn');
        if(cancelBtn) cancelBtn.classList.add('hidden');
    }

    // --- UTILITY AND INITIALIZATION ---
    async function seedDatabaseWithInitialEvents() {
         const initialEvents=[{type:"Training",title:"New Volunteer Training",date:"2024-08-20",time:"7:00pm - 8:00pm",location:"Room H6",slots:20,filled:15,attendees:[]},{type:"Training",title:"Van Gogh Lesson Prep",date:"2024-09-17",time:"7:00pm - 8:00pm",location:"Room H6",slots:20,filled:8,attendees:[]},{type:"Art Session",title:"Mrs. Davis' 3rd Grade - Monet",date:"2024-09-25",time:"10:00am - 11:30am",location:"Room 12",slots:3,filled:1,attendees:[]},{type:"Art Session",title:"Mr. Chen's 4th Grade - Monet",date:"2024-09-26",time:"1:00pm - 2:30pm",location:"Room 15",slots:3,filled:3,attendees:[]},{type:"Event",title:"School Art Showcase",date:"2025-05-02",time:"6:00pm - 8:00pm",location:"MP Room",slots:10,filled:2,role:"Setup Help",attendees:[]}];

         // Ensure db and eventsCollectionRef are initialized before seeding
         if (!db || !eventsCollectionRef) {
             console.error("Firestore not initialized, cannot seed database.");
             return;
         }

         try {
             const snapshot = await getDocs(eventsCollectionRef);
             if (snapshot.empty) {
                 console.log("Database is empty, seeding with initial events...");
                 for (const event of initialEvents) {
                     await addDoc(eventsCollectionRef, event);
                 }
                 console.log("Initial events seeded successfully.");
             } else {
                 console.log("Database already contains events, skipping seeding.");
             }
         } catch (error) {
             console.error("Error seeding database:", error);
             showNotification('Data Error', 'Failed to seed initial events. Check console for details.', 'error');
         }
    }

    function showNotification(title, message, type = 'success') {
        const modal=document.getElementById('notification-modal');
        const titleEl=document.getElementById('notification-title');
        const messageEl=document.getElementById('notification-message');
        const iconEl=document.getElementById('notification-icon');
        const btnEl=document.getElementById('notification-close-btn');

        if (!modal || !titleEl || !messageEl || !iconEl || !btnEl) {
            console.error("Notification elements not found. Cannot show notification.");
            return;
        }

        titleEl.textContent=title;
        messageEl.textContent=message;

        if(type==='error'){
            iconEl.className='mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100';
            iconEl.innerHTML=`<svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            btnEl.className='px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300';
        }else{
            iconEl.className='mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100';
            iconEl.innerHTML=`<svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            btnEl.className='px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300';
        }
        modal.classList.remove('hidden');
    }
    document.getElementById('notification-close-btn').addEventListener('click', () => {
        const modal = document.getElementById('notification-modal');
        if(modal) modal.classList.add('hidden');
    });

    function openMobileMenu() {
        mobileSidebar.classList.remove('hidden');
        setTimeout(() => {
            mobileSidebarBackdrop.classList.remove('opacity-0');
            mobileSidebarBackdrop.classList.add('opacity-75');
            mobileSidebarPanel.classList.remove('-translate-x-full');
            mobileSidebarPanel.classList.add('translate-x-0');
        }, 10);
    }

    function closeMobileMenu() {
        mobileSidebarBackdrop.classList.remove('opacity-75');
        mobileSidebarBackdrop.classList.add('opacity-0');
        mobileSidebarPanel.classList.remove('translate-x-0');
        mobileSidebarPanel.classList.add('-translate-x-full');
        setTimeout(() => {
            mobileSidebar.classList.add('hidden');
        }, 300);
    }

    // Helper function to wait for Firebase Auth readiness
    function waitForAuthAndLoad(callback) {
        // We'll check for both isAuthReady and db initialization
        if (isAuthReady && db) {
            callback();
        } else {
            const interval = setInterval(() => {
                if (isAuthReady && db) {
                    clearInterval(interval);
                    callback();
                }
            }, 100);
            // Add a timeout to prevent infinite loop if auth never becomes ready
            setTimeout(() => {
                if (!isAuthReady || !db) {
                    clearInterval(interval);
                    console.warn("Timed out waiting for Firebase authentication/initialization. Please check your Firebase configuration and network connection.");
                    showNotification('Connection Error', 'Failed to connect to the application services. Please refresh the page.', 'error');
                }
            }, 10000); // 10 seconds timeout
        }
    }

    // Main initialization function to run on DOMContentLoaded
    async function initializeAppAndUI() {
        // Run setupAuth first. The db variable will be set inside try/catch block if successful.
        await setupAuth();
        // Only proceed if db is successfully initialized
        if (!db) {
            console.error("Firebase database could not be initialized. Aborting UI initialization.");
            return;
        }

        mobileMenuButton.addEventListener('click', openMobileMenu);
        mobileMenuCloseButton.addEventListener('click', closeMobileMenu);
        mobileSidebarBackdrop.addEventListener('click', closeMobileMenu);
        updateNavLinks(currentRoute.page);
        renderPage(currentRoute);
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        await initializeAppAndUI();
    });

</script>
</body>
</html>
